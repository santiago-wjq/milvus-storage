name: Java Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string
      publish_target:
        description: 'Publish target'
        required: true
        type: choice
        options:
          - github
          - maven-central
          - both
        default: github
      skip_tests:
        description: 'Skip tests before release'
        required: false
        type: boolean
        default: false

  push:
    tags:
      - 'java-v[0-9]+.[0-9]+.[0-9]+'
      - 'java-v[0-9]+.[0-9]+.[0-9]+-*'

env:
  CONAN_VERSION: "1.61.0"

jobs:
  # Build for Linux x86_64
  build-linux-x86_64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install C++ dependencies
        uses: aminya/setup-cpp@v1
        with:
          conan: ${{ env.CONAN_VERSION }}
          cmake: true

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Setup Conan remote
        run: |
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert
          conan remote list

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan
          key: conan-java-linux-${{ hashFiles('./cpp/conanfile.py') }}
          restore-keys: conan-java-linux-

      - name: Build JNI library
        working-directory: ./cpp
        run: |
          make java-lib

      - name: Prepare native libraries
        run: |
          mkdir -p java/native/linux-x86_64
          cp cpp/build/Release/lib/libmilvus-storage-jni.so java/native/linux-x86_64/
          cp cpp/build/Release/lib/libmilvus-storage.so java/native/linux-x86_64/

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-x86_64
          path: java/native/linux-x86_64/

  # Build for Linux ARM64
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install C++ dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake python3 python3-pip
          pip3 install conan==1.61.0
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Conan remote
        run: |
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert || true
          conan remote list

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan
          key: conan-java-linux-arm64-${{ hashFiles('./cpp/conanfile.py') }}
          restore-keys: conan-java-linux-arm64-

      - name: Build JNI library
        working-directory: ./cpp
        run: |
          make java-lib

      - name: Prepare native libraries
        run: |
          mkdir -p java/native/linux-aarch64
          cp cpp/build/Release/lib/libmilvus-storage-jni.so java/native/linux-aarch64/
          cp cpp/build/Release/lib/libmilvus-storage.so java/native/linux-aarch64/

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-arm64
          path: java/native/linux-aarch64/

  # Build for macOS ARM64
  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install C++ dependencies
        run: |
          brew install conan@1 cmake
          export PATH="/opt/homebrew/opt/conan@1/bin:$PATH"

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Conan remote
        run: |
          export PATH="/opt/homebrew/opt/conan@1/bin:$PATH"
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert || true
          conan remote list

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan
          key: conan-java-macos-arm64-${{ hashFiles('./cpp/conanfile.py') }}
          restore-keys: conan-java-macos-arm64-

      - name: Build JNI library
        working-directory: ./cpp
        run: |
          export PATH="/opt/homebrew/opt/conan@1/bin:$PATH"
          make java-lib

      - name: Prepare native libraries
        run: |
          mkdir -p java/native/darwin-aarch64
          cp cpp/build/Release/lib/libmilvus-storage-jni.dylib java/native/darwin-aarch64/
          cp cpp/build/Release/lib/libmilvus-storage.dylib java/native/darwin-aarch64/

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-macos-arm64
          path: java/native/darwin-aarch64/

  # Package and test
  package:
    needs: [build-linux-x86_64, build-linux-arm64, build-macos-arm64]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: java/native/
          pattern: native-*
          merge-multiple: true

      - name: List native libraries
        run: |
          find java/native -type f -name "*.so" -o -name "*.dylib" | head -20

      - name: Set version
        working-directory: ./java
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'java-v' prefix)
            VERSION="${GITHUB_REF_NAME#java-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          # Update version in build.sbt
          sed -i "s/version := \".*\"/version := \"${VERSION}\"/" build.sbt
          echo "Set version to ${VERSION}"

      - name: Run tests
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        working-directory: ./java
        run: |
          # Copy Linux library for testing
          cp native/linux-x86_64/libmilvus-storage-jni.so .
          export LD_PRELOAD=$(pwd)/native/linux-x86_64/libmilvus-storage.so
          sbt test

      - name: Build fat JAR
        working-directory: ./java
        run: |
          sbt assembly

      - name: Build regular JAR
        working-directory: ./java
        run: |
          sbt package

      - name: Upload JAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jars
          path: |
            java/target/scala-*/milvus-storage-*.jar
            java/target/scala-*/*.pom

  # Publish to GitHub Packages
  publish-github:
    needs: [package]
    if: |
      always() &&
      needs.package.result == 'success' &&
      (github.event_name == 'push' ||
       github.event.inputs.publish_target == 'github' ||
       github.event.inputs.publish_target == 'both')
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Download native libraries
        uses: actions/download-artifact@v4
        with:
          path: java/native/
          pattern: native-*
          merge-multiple: true

      - name: Set version
        working-directory: ./java
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#java-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          sed -i "s/version := \".*\"/version := \"${VERSION}\"/" build.sbt

      - name: Publish to GitHub Packages
        working-directory: ./java
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sbt publish

  # Publish to Maven Central
  publish-maven-central:
    needs: [package]
    if: |
      always() &&
      needs.package.result == 'success' &&
      (github.event.inputs.publish_target == 'maven-central' ||
       github.event.inputs.publish_target == 'both')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Download native libraries
        uses: actions/download-artifact@v4
        with:
          path: java/native/
          pattern: native-*
          merge-multiple: true

      - name: Set version
        working-directory: ./java
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#java-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          sed -i "s/version := \".*\"/version := \"${VERSION}\"/" build.sbt

      - name: Publish to Maven Central
        working-directory: ./java
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          sbt publishSigned

  # Create GitHub Release
  create-release:
    needs: [package, publish-github]
    if: |
      always() &&
      needs.package.result == 'success'
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: jars
          path: dist/

      - name: Set version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#java-v}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: java-v${{ env.VERSION }}
          name: Java Release v${{ env.VERSION }}
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
          files: |
            dist/**/*.jar
          body: |
            ## Java/Scala Release v${{ env.VERSION }}

            ### Installation

            **Maven:**
            ```xml
            <dependency>
              <groupId>com.zilliz</groupId>
              <artifactId>milvus-storage-jni</artifactId>
              <version>${{ env.VERSION }}</version>
            </dependency>
            ```

            **SBT:**
            ```scala
            libraryDependencies += "com.zilliz" % "milvus-storage-jni" % "${{ env.VERSION }}"
            ```

            ### Supported Platforms
            - Linux x86_64
            - Linux ARM64 (aarch64)
            - macOS ARM64 (Apple Silicon)
